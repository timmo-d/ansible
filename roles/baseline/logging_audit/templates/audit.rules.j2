## BEGIN - Canonical Ubuntu 24.04 STIG/USG aligned audit rules
## Identity & account management
-w /etc/passwd -p wa -k identity
-w /etc/group  -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

## Session logs
-w /var/log/wtmp -p wa -k session
-w /var/log/btmp -p wa -k session
-w /var/log/lastlog -p wa -k session
-w /var/run/utmp -p wa -k session

## Time change
-a always,exit -F arch=b64 -S adjtimex,settimeofday,clock_settime -F auid>=1000 -F auid!=4294967295 -k time-change
-a always,exit -F arch=b32 -S adjtimex,settimeofday,clock_settime -F auid>=1000 -F auid!=4294967295 -k time-change
-w /etc/localtime -p wa -k time-change

## Discretionary Access Control changes (chmod/chown/setxattr…) – b32/b64
{% for arch in ['b64','b32'] %}
-a always,exit -F arch={{arch}} -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch={{arch}} -S chown,fchown,lchown,fchownat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch={{arch}} -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod
{% endfor %}

## File deletions
{% for arch in ['b64','b32'] %}
-a always,exit -F arch={{arch}} -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=4294967295 -k delete
{% endfor %}

## Unsuccessful file modifications (open/truncate/creat…) – both arch
{% for arch in ['b64','b32'] %}
-a always,exit -F arch={{arch}} -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch={{arch}} -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EPERM  -F auid>=1000 -F auid!=4294967295 -k access
{% endfor %}

## Kernel module loading/unloading
{% for arch in ['b64','b32'] %}
-a always,exit -F arch={{arch}} -S init_module,finit_module,delete_module -F auid>=1000 -F auid!=4294967295 -k modules
{% endfor %}

## Mounts
{% for arch in ['b64','b32'] %}
-a always,exit -F arch={{arch}} -S mount,umount2 -F auid>=1000 -F auid!=4294967295 -k mounts
{% endfor %}

## Privileged commands (adjustable)
{% for bin in audit_privileged_bins | default(['/usr/bin/sudo','/usr/bin/su','/usr/sbin/useradd','/usr/sbin/usermod','/usr/sbin/userdel','/usr/bin/chage','/usr/bin/passwd','/usr/bin/gpasswd','/usr/sbin/cron','/usr/bin/crontab','/usr/sbin/visudo','/usr/sbin/apparmor_parser']) %}
-a always,exit -F path={{bin}} -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged
{% endfor %}

## Journald directory watch
-w /var/log/journal/ -p wa -k journald

## SUDO & SU logs and configuration
-w /etc/sudoers -p wa -k scope
-w /etc/sudoers.d/ -p wa -k scope
-w /var/log/sudo.log -p wa -k actions

## Auditd configuration protection
-w /etc/audit/ -p wa -k auditconfig
-w /etc/libaudit.conf -p wa -k auditconfig

## Persist
-e 2
## END
