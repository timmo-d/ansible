---

- name: Install chrony time synchronization
  apt:
    name: chrony
    state: present

- name: Configure chrony servers and options
  template:
    src: "{{ role_path }}/system_config/templates/chrony.conf.j2"
    dest: /etc/chrony/chrony.conf
  notify: restart_chrony

- name: Ensure chrony service enabled and running
  systemd:
    name: chrony
    enabled: yes
    state: started

- name: "TIME | chrony selected (CIS-aligned)"
  when: time_sync_provider == 'chrony'
  block:
    - apt:
        name: chrony
        state: present
        update_cache: yes
    - lineinfile:
        path: /etc/chrony/chrony.conf
        regexp: '^(pool|server)\s+'
        line: ''
        state: absent
    - blockinfile:
        path: /etc/chrony/chrony.conf
        marker: "# {mark} CIS chrony"
        block: |
          {% for s in chrony_servers %}
          {{ s }}
          {% endfor %}
    - systemd: { name: chrony, enabled: yes, state: started }
  
- name: Gather service facts
  service_facts:

