---
# cloudflared_tunnel.yml
# Self-healing Cloudflare Tunnel provisioning in headless token mode

# -------------------------
# 0. Preconditions
# -------------------------

- name: Ensure cloudflared config directory exists
  file:
    path: /etc/cloudflared
    state: directory
    owner: root
    group: root
    mode: '0755'

# -------------------------
# 1. API-first detection / creation
# -------------------------

- name: Check if tunnel exists by name via Cloudflare API
  uri:
    url: "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/cfd_tunnel?name={{ tunnel_name }}"
    method: GET
    headers:
      Authorization: "Bearer {{ cloudflare_api_token }}"
      Content-Type: "application/json"
    return_content: yes
    status_code: 200
  register: tunnel_check

- name: Create tunnel if not found
  uri:
    url: "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/cfd_tunnel"
    method: POST
    headers:
      Authorization: "Bearer {{ cloudflare_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ tunnel_name }}"
    return_content: yes
    status_code: 200
  register: tunnel_create
  when: (tunnel_check.json.result | default([])) | length == 0

- name: Set unified tunnel_id_final fact
  set_fact:
    tunnel_id_final: >-
      {{
        (tunnel_check.json.result[0].id)
        if (tunnel_check.json.result | default([])) | length > 0
        else (tunnel_create.json.result.id)
      }}

- name: Fail if tunnel_id_final is not set
  fail:
    msg: "No tunnel ID available â€” cannot proceed."
  when: tunnel_id_final | default('') | length == 0

# -------------------------
# 2. Fetch credentials for tunnel_id_final
# -------------------------

- name: Fetch tunnel token JSON
  uri:
    url: "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/cfd_tunnel/{{ tunnel_id_final }}/token"
    method: GET
    headers:
      Authorization: "Bearer {{ cloudflare_api_token }}"
      Content-Type: "application/json"
    return_content: yes
    status_code: 200
  register: tunnel_creds

- name: Fail if API did not return success
  fail:
    msg: "Failed to fetch tunnel token: {{ tunnel_creds.json.errors | to_nice_json }}"
  when: not tunnel_creds.json.success | default(false)

- name: Write tunnel credentials file
  copy:
    content: "{{ tunnel_creds.content }}"
    dest: "/etc/cloudflared/{{ tunnel_id_final }}.json"
    owner: root
    group: root
    mode: '0600'

# -------------------------
# 3. Render config and validate
# -------------------------

- name: Write config.yml for cloudflared
  template:
    src: config.yml.j2
    dest: /etc/cloudflared/config.yml
    owner: root
    group: root
    mode: '0644'

- name: Validate cloudflared config YAML
  command: python3 -c 'import yaml,sys; yaml.safe_load(open("/etc/cloudflared/config.yml")) or sys.exit(0)'
  changed_when: false

# -------------------------
# 4. Systemd service
# -------------------------

- name: Create systemd service for cloudflared tunnel
  copy:
    dest: /etc/systemd/system/cloudflared.service
    owner: root
    group: root
    mode: '0644'
    content: |
      [Unit]
      Description=Cloudflare Tunnel
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=notify
      ExecStart={{ cloudflared_bin_path | default('/usr/local/bin/cloudflared') }} tunnel --config /etc/cloudflared/config.yml run {{ tunnel_id_final }}
      Restart=on-failure
      RestartSec=5s
      TimeoutStartSec=0
      LimitNOFILE=65536

      [Install]
      WantedBy=multi-user.target

# -------------------------
# 5. Validate credentials file structure
# -------------------------

- name: Read tunnel ID from config.yml
  slurp:
    path: /etc/cloudflared/config.yml
  register: config_file_raw

- set_fact:
    config_tunnel_id: "{{ (config_file_raw.content | b64decode | from_yaml).tunnel | string }}"

- name: Read credentials JSON
  slurp:
    path: "/etc/cloudflared/{{ tunnel_id_final }}.json"
  register: creds_file_raw

- set_fact:
    creds_json: "{{ creds_file_raw.content | b64decode | from_json }}"

- fail:
    msg: >-
      Invalid credentials file: expected keys AccountTag, TunnelID, TunnelName, TunnelSecret.
      Found keys: {{ creds_json.keys() | join(', ') }}
  when: not (
          'AccountTag' in creds_json and
          'TunnelID' in creds_json and
          'TunnelName' in creds_json and
          'TunnelSecret' in creds_json
        )

- fail:
    msg: >-
      Tunnel ID mismatch:
      config.yml has {{ config_tunnel_id }},
      credentials file has {{ creds_json.TunnelID }}.
  when: config_tunnel_id != creds_json.TunnelID

# -------------------------
# 6. Reload daemon and start service
# -------------------------

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable and start cloudflared service
  systemd:
    name: cloudflared
    enabled: yes
    state: started
