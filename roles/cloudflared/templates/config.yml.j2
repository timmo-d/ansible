{% set ingress_list = [] %}

# Add ingress rules for each app hostname from app_hostnames
{% for app in nginx_upstreams | default([]) %}
  {% if app.public_hostname is defined and (app.public_hostname|string)|length > 0 %}
    {% set _ = ingress_list.append({'hostname': app.public_hostname, 'service': 'http://127.0.0.1:80'}) %}
  {% endif %}
{% endfor %}

# Add any extra ingress rules from cloudflared_ingress var
{% for rule in cloudflared_ingress | default([]) %}
  {% set host = rule.hostname if rule.hostname is defined else rule.domain %}
  {% if host is defined and (host|string)|length > 0 %}
    {% set _ = ingress_list.append({'hostname': host, 'service': 'http://127.0.0.1:80'}) %}
  {% else %}
    {% set _ = ingress_list.append({'service': 'http://127.0.0.1:80'}) %}
  {% endif %}
{% endfor %}

# Always add a catchâ€‘all rule last
{% set _ = ingress_list.append({'service': 'http_status:404'}) %}

tunnel: {{ tunnel_id_final }}
credentials-file: /etc/cloudflared/{{ tunnel_id_final }}.json
ingress:
{{ ingress_list | to_nice_yaml(indent=2) | indent(2, true) }}
