

- name: Ensure required system packages are installed
  apt:
    name:
      - git
      - build-essential
      - python3-dev
      - libyaml-dev
      - libffi-dev
      - libssl-dev
    state: present
    update_cache: true
  become: true

- name: Clone Huntarr.io repository to /tmp
  git:
    repo: "{{ huntarr_repo }}"
    dest: "{{ huntarr_repo_tmp }}"
    version: "HEAD"
    force: yes

- name: Create install directory
  file:
    path: "{{ install_dir }}"
    state: directory
    owner: "{{ huntarr_user }}"
    group: media
    mode: '0755'
  become: true

- name: Create data directory
  file:
    path: "{{ data_dir }}"
    state: directory
    owner: "{{ huntarr_user }}"
    group: media
    mode: '0755'
  become: true

- name: Move Huntarr.io contents to install directory
  command: >
    rsync -a {{ huntarr_repo_tmp }}/ {{ install_dir }}/
  become: true

- name: Create Python virtual environment
  command: python3 -m venv {{ huntarr_venv_dir }}
  args:
    creates: "{{ huntarr_venv_dir }}/bin/activate"
  become: true

- name: Upgrade pip, setuptools, wheel in virtualenv
  command: "{{ huntarr_venv_dir }}/bin/pip install --upgrade pip setuptools wheel"
  become: true

- name: Install PyYAML separately to avoid build issues
  command: "{{ huntarr_venv_dir }}/bin/pip install pyyaml==6.0 --prefer-binary"
  become: true

- name: Install remaining Python dependencies in virtualenv
  command: "{{ huntarr_venv_dir }}/bin/pip install -r {{ install_dir }}/requirements.txt --no-deps"
  become: true

- name: Set ownership of virtualenv to huntarr
  file:
    path: "{{ huntarr_venv_dir }}"
    state: directory
    recurse: true
    owner: "{{ huntarr_user }}"
    group: media
  become: true

- name: Deploy Huntarr systemd service template
  template:
    src: huntarr.service.j2
    dest: "{{ huntarr_service_path }}"
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd
  become: true

- name: Enable and start Huntarr service
  systemd:
    name: huntarr.service
    enabled: true
    state: started
  become: true

- name: Remove temporary Huntarr.io repo
  file:
    path: "{{ huntarr_repo_tmp }}"
    state: absent
  become: true