- name: Install UFW
  apt:
    name: ufw
    state: present

- name: Set default policies
  become: true
  ufw:
    state: enabled
    policy: deny
    direction: incoming

- name: Allow SSH
  become: true
  ufw:
    rule: allow
    name: OpenSSH

- name: UFW - allow SIEM/SOC TCP ports
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: tcp
    from: "{{ mgmt_allow_cidrs | join(',') }}"
  loop:
    - { port: "5601" }  # Kibana Web interface
    - { port: "9200" }  # Indexer API (used by Kibana and Filebeat)
    - { port: "9300" }  # Internal cluster communication (multi-node setups)
    - { port: "5044" }  # Logstash Beats
    - { port: "1514" }  # Wazuh Agent event reporting
    - { port: "1515" }  # Wazuh Agent registration
    - { port: "1516" }  # Wazuh Cluster communication (if using multi-node setup)
    - { port: "55000" } # Wazuh REST API (used by Dashboard and integrations)
    - { port: "541" }   # Wazuh Dashboard
    - { port: "9090" }  # Prometheus
    - { port: "3000" }  # Grafana
    - { port: "514" }   # Syslog TCP
    - { port: "443" }   # Wazuh Dashboard port

- name: UFW - allow SIEM/SOC UDP ports
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: tcp
    from: "{{ mgmt_allow_cidrs | join(',') }}"
  loop:
    - { port: "514" }  # Syslog UDP
    - { port: "1514" }  # Wazuh UDP

