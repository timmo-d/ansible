- block:

  - name: Ensure Dashboard certificates directory permissions.
    file:
      path: "/etc/wazuh-dashboard/certs/"
      state: directory
      owner: wazuh-dashboard
      group: wazuh-dashboard
      mode: 500

  - name: Copy the certificates from local to the Wazuh dashboard instance
    copy:
      src: "{{ local_certs_path }}/wazuh-certificates/{{ item }}"
      dest: /etc/wazuh-dashboard/certs/
      owner: wazuh-dashboard
      group: wazuh-dashboard
      mode: 0400
      remote_src: yes
    with_items:
      - "root-ca.pem"
      - "{{ dashboard_node_name }}-key.pem"
      - "{{ dashboard_node_name }}.pem"
  tags:
  - security

# Generate self-signed certificate for https to Wazuh Dashboard
- name: Generate private key (idempotent)
  community.crypto.openssl_privatekey:
    path: "{{ dashboard_key_path }}"
    size: "{{ dashboard_key_size }}"
    type: RSA
    owner: "{{ ssl_owner }}"
    group: "{{ ssl_group }}"
    mode: "{{ key_mode }}"

- name: Create CSR with SANs (idempotent)
  community.crypto.openssl_csr:
    path: "{{ dashboard_csr_path }}"
    privatekey_path: "{{ dashboard_key_path }}"
    common_name: "{{ dashboard_ssl_cn }}"
    subject_alt_name: "{{ dashboard_ssl_sans }}"
    owner: "{{ ssl_owner }}"
    group: "{{ ssl_group }}"
    mode: "0644"

- name: Create selfâ€‘signed certificate (idempotent)
  community.crypto.x509_certificate:
    path: "{{ dashboard_crt_path }}"
    privatekey_path: "{{ dashboard_key_path }}"
    csr_path: "{{ dashboard_csr_path }}"
    provider: selfsigned
    days: "{{ dashboard_cert_days }}"
    subject_alt_name: "{{ dashboard_ssl_sans }}"
    owner: "{{ ssl_owner }}"
    group: "{{ ssl_group }}"
    mode: "{{ crt_mode }}"
    select_crypto_backend: cryptography
